<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <title>Book Collection</title>
 <style>
  * {
    box-sizing: border-box;
  }
  

  .column {
    float: left;
    width: 50%;
    padding: 10px;
    height: 300px; /* Should be removed. Only for demonstration */
  }
  
  .button{
    width: 15%;
  }
  
  .bookHeader{
    width: 40%;
  }

  .textInput{
    width: 90%;
    padding: 7px 14px;
  }

  .descInput{
    width: 90%;
    padding: 7px 14px;
  }

  h1{
    text-align: center;
  }
  

  .row:after {
    content: "";
    display: table;
    clear: both;
  }
  </style>
</head>

<body>
  <h1>Book Collection</h1>
  
   <div class="row">
    <div class="column">

   <form action="/books" method="patch">
    Title:<br/>
    <input id="titleForm" type="text" name="Title" class="textInput">
    <br/>
    <br/>
    Author:<br/>
    <input id="authorForm" type="text" name="Author" class="textInput">
    <br/>
    <br/> Description:<br/>
    <textarea id="descriptionForm" name="Text1" cols="40" rows="5" class="descInput">
    
    </textarea>
    <br/><br/>
    <input id=saveNewBtn type="button" value="Save New" class="button" onclick="addNewBook()">
    <input id=saveBtn type="button" value="Save" class="button" disabled=true onclick="updateBook()"> 
    <input id=deleteBtn type="button" value="Delete" class="button" disabled=true onclick="deleteBook()">
  </form>
  </table>
  </div>
</th>

  <div class="column">
  <table width=90%>
    <tr>
      <th width=20% >Title</th>
      <th width=20% >Author</th>
      <th width=50% >Description</th>
    </tr>
    </tr>
  </table>
</div>
</div>
  <br/>

  <script>


    bookTable = document.querySelector("table")
    let selectedtd
    bookTable.onclick = function (event){
      let target = event.target.closest('tr');
      // If we miss entirely, let's pretend we didn't.
      if (target != null){
      // Clicking on header row? Let's ignore that.  
        if (target.id == '') return;
        clickHandler(target)
      }else{
        return;
      }
    }

    fetch("/books")
      .then(response => response.json())
      .then(bookList => {
        
        bookList.forEach(book => {
          
          // Create the table row
          row = document.createElement("tr")
          //row.id = "row" + book.id
          row.id = book.id

          title = document.createElement("td")
          title.id = "title_"+row.id
          title.innerHTML = book.title
          author = document.createElement("td")
          author.id = "author_"+row.id
          author.innerHTML = book.author
          description = document.createElement("td")
          description.id = "description_"+row.id
          description.innerHTML = book.description
  
          

          row.appendChild(title);
          row.appendChild(author);
          row.appendChild(description);
          
          bookTable.appendChild(row)

        })
      })

      // ClickHandler, when clicking on book copies that data to the form.
      function clickHandler(input){
        //backupFormData();

        // Transfer data from clicked row to form.
        
        // Remove the old and save the Id of the current book
        sessionStorage.removeItem("currentId");
        sessionStorage.setItem("currentId",input.id);

        document.getElementById("titleForm").value = document.getElementById("title_"+input.id).innerHTML;
        document.getElementById("authorForm").value = document.getElementById("author_"+input.id).innerHTML;
        document.getElementById("descriptionForm").value =  document.getElementById("description_"+input.id).innerHTML;
        // Enabling Save button 
        document.getElementById("saveBtn").disabled = false;
        // Enabling Delete button
        document.getElementById("deleteBtn").disabled = false;
        // Disabling Save New button
        document.getElementById("saveNewBtn").disabled = true;
        //Debugging console output.
        //console.log(input.id);
        backupFormData();
      }

      function changeInput(){
        
      }
      // Copy form data to sessionStorage so we can compare it to changes made by the user
      function backupFormData(){
        // Clear previous values because we can't change them
        sessionStorage.removeItem("prevID");
        sessionStorage.removeItem("prevTitle");
        sessionStorage.removeItem("prevAuthor");
        sessionStorage.removeItem("prevDescription");
        
        // Temporary variables for saving data, didn't seem to like when
        // trying to insert them directly to sessionsStorage 
        let titleTemp = document.getElementById("titleForm").value;
        let authorTemp = document.getElementById("authorForm").value;
        let descriptionTemp = document.getElementById("descriptionForm").value;    
        
        // Create new sessionStorage items
        sessionStorage.setItem("prevTitle",titleTemp);
        sessionStorage.setItem("prevAuthor",authorTemp);
        sessionStorage.setItem("prevDescription",descriptionTemp);

        // Console output for testing.
        console.log(titleTemp);
        console.log(authorTemp);
        console.log(descriptionTemp);
      }
      
      // Send new book data to backend.
      function addNewBook(){
        // Data for json object
        let titleTemp = document.getElementById("titleForm").value;
        let authorTemp = document.getElementById("authorForm").value;
        let descriptionTemp = document.getElementById("descriptionForm").value;    
        
        (async () => {
            const rawResponse = await fetch('http://localhost:8080/books', {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
          body: JSON.stringify({title : titleTemp, author: authorTemp,description: descriptionTemp})
          });
        const content = await rawResponse.json();
        console.log(content);
      })();
      
      }

      // Send updated book data to backend.
      function updateBook(){

        // Data for json object
        let titleTemp = document.getElementById("titleForm").value;
        let authorTemp = document.getElementById("authorForm").value;
        let descriptionTemp = document.getElementById("descriptionForm").value;    
        
        (async () => {
            const rawResponse = await fetch('http://127.0.0.1:8080/books/'+sessionStorage.getItem("currentId"), {
            method: 'PATCH',
            //mode: 'no-cors',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
              'Access-Control-Allow-Header': '*',
            },
          body: JSON.stringify({title : titleTemp, author: authorTemp,description: descriptionTemp})
          });
        const content = await rawResponse.json();
        console.log(content);
      })();
      

      }
      // Remove book from database.
      function deleteBook(){

      }
  </script>
</body>